#!/bin/bash

# the directory path of the results
PROJECTNAME="STINGRAY_Availability"

####################################


# the list of the dat files, one for each experiment, associated to each solver and to the  basename of the results file, in detail:
# list of .dat files generated by each solver, including in each line the basename of the results file, a solver name and all the .dat files, one for each experiment, associated to the solver:
# <results_file_basename> <solver_name> <comma_separed_list_of_dat_files>
DATFILELIST="
#Results sim 
#sim_vardelta1_T00_T0Var0p5_DPDeltaT0p5_DPVar0p5 1* 2
#sim_vardelta1_T00_T0Var0p6_DPDeltaT0p5_DPVar0p6 1
#sim_vardelta1_T00_T0Var0p6_DPDeltaT0p5_DPVar0p8 1
#sim_vardelta_T0m15_T0w10_DPT0diff10_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w10_DPT0diff10_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w10_DPT0diff5_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w10_DPT0diff5_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w10_DPT0diff1_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w10_DPT0diff1_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w1_DPT0diff10_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w1_DPT0diff10_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w1_DPT0diff1_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m15_T0w1_DPT0diff1_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w10_DPT0diff10_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w10_DPT0diff10_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w10_DPT0diff1_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w10_DPT0diff1_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w1_DPT0diff10_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w1_DPT0diff10_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w1_DPT0diff1_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T00_T0w1_DPT0diff1_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
sim_vardelta_T0m5_T0w10_DPT0diff10_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
sim_vardelta_T0m5_T0w10_DPT0diff10_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
sim_vardelta_T0m5_T0w10_DPT0diff1_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
sim_vardelta_T0m5_T0w10_DPT0diff1_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
sim_vardelta_T0m5_T0w1_DPT0diff10_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
sim_vardelta_T0m5_T0w1_DPT0diff10_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m5_T0w1_DPT0diff1_DPw10 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
#sim_vardelta_T0m5_T0w1_DPT0diff1_DPw1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
"

########### MAIN CODE ##############

main() {
    init
    checkin
    #makedarep
    #makeparams
    makesolvers
    launchsolvers    
}


# set variables
init() {
    PROJECTS="${HOME}/MobiusProject"
    PARAMS="${PROJECTS}/${PROJECTNAME}/params"
    DAREP="${PROJECTS}/${PROJECTNAME}/darep"
    SRC="${PARAMS}/src"
    DAREPBIN="${PARAMS}/bin"
    PARAMSBIN="${PARAMS}/bin"
    HOST=$(uname -n)
    # get arch
    if [ "$(uname -s)" == "Darwin" ]; then
	ARCH="macosx"
    else
	ARCH="linux"
    fi    
}

# check input files
checkin() {
    # remove comments
    MYSOLVER_LIST=$(echo "${SOLVER_LIST}" | awk '!/^[ ]*#.*/ {printf "%s\n", $0}')
}

# process binary result files to get csv and txt files
processbinresults() {

    # generate commands for mobius shell
    cat << EOF > ${MSHELLBATCH}
open ${PROJECTNAME}
EOF

    IFS=$'\n'
    for DATFILEINFO  in $(printf "${DATFILELIST}"); do # for each list of dat files associated to each solver
        RESULTSBASEFILENAME=$(echo "$DATFILEINFO" | awk '{print $1}')
	SOLVERNAME=$(echo "$DATFILEINFO" | awk '{print $2}')
        DATFILES=$(echo "$DATFILEINFO" | awk '{$1=""; $2=""}1')

        # commands for mobius shell
        cat << EOF >> ${MSHELLBATCH}
open s ${SOLVERNAME}
EOF

        unset IFS # space separed .dat file names
        for RESDATINFO  in $(printf "${DATFILES}"); do # for each dat file associated to each solver
	    EXPRESFILEBASENAME=$(echo "$RESDATINFO" | awk -F',' '{print $1}')
	    DATFILE=$(echo "$RESDATINFO" | awk -F',' '{print $2}')
            
            # make temporary file including mobius-shell commands to generate csv results file from .dat file
            cat << EOF >> ${MSHELLBATCH}
results -f -t csv -o ${EXPRESFILEBASENAME} -b ${DATFILE}
results -f -t txt -o ${EXPRESFILEBASENAME} -b ${DATFILE}
EOF
            
        done # for each dat file associated to each solver
        IFS=$'\n'

        # commands for mobius shell
        cat << EOF >> ${MSHELLBATCH}
close
EOF

    done # for each list of dat files associated to each solver
    unset IFS

        # commands for mobius shell
        cat << EOF >> ${MSHELLBATCH}
close
exit
EOF

        # print commands for mobius shell
        echo "mobius shell commands: "
        cat "${MSHELLBATCH}"
        # mobius shell
        # use eval otherwise mshell fails
        echo "running mobius shell ..."
        bash -c "${MSHELL} -s ${MSHELLBATCH}"
        
        # remove mobius-shell temporary file
        rm -f ${MSHELLBATCH}
}

main "$@"
